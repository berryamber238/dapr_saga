version: '3.9'

services:
  ############################
  # Infrastructure Services
  ############################
  
  placement:
    image: daprio/dapr:1.16.5
    command: ["./placement", "--port", "50005"]
    ports:
      - "60006:50005"
    networks:
      - dapr-network

  scheduler:
    image: daprio/dapr:1.16.5
    command: ["./scheduler", "--port", "50006", "--etcd-data-dir", "/tmp/dapr-scheduler-data"]
    ports:
      - "50006:50006"
    networks:
      - dapr-network

  zipkin:
    image: openzipkin/zipkin
    ports:
      - "9411:9411"
    networks:
      - dapr-network

  mongodb:
    image: mongo:latest
    container_name: dapr_mongodb
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: test $$(echo "rs.initiate({_id:'rs0',members:[{_id:0,host:'mongodb:27017'}]}).ok || rs.status().ok" | mongosh --port 27017 --quiet) -eq 1
      interval: 10s
      start_period: 30s
    networks:
      - dapr-network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: dapr_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - dapr-network

  ############################
  # Application Services
  ############################

  # 1. Saga Coordinator
  saga-coordinator:
    build:
      context: .
      dockerfile: src/Saga.Coordinator/Dockerfile
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      scheduler:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  saga-coordinator-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "saga-coordinator", 
      "-app-port", "8080", 
      "-dapr-grpc-port", "50001",
      "-placement-host-address", "placement:50005",
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml",
      "-log-level", "debug"
    ]
    volumes:
      - ./docker-components/:/components
    environment: &dapr-env
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=guest
      - RABBITMQ_PASSWORD=guest
    depends_on:
      - saga-coordinator
    network_mode: "service:saga-coordinator"
    restart: always

  # 2. Service CTA
  service-cta:
    build:
      context: .
      dockerfile: src/Service.CTA/Dockerfile
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  service-cta-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-cta", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - service-cta
    network_mode: "service:service-cta"
    restart: always

  # 3. Service Genesis
  service-genesis:
    build:
      context: .
      dockerfile: src/Service.Genesis/Dockerfile
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  service-genesis-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-genesis", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - service-genesis
    network_mode: "service:service-genesis"
    restart: always

  # 4. Service PerfectCage
  service-perfectcage:
    build:
      context: .
      dockerfile: src/Service.PerfectCage/Dockerfile
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  service-perfectcage-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-perfectcage", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - service-perfectcage
    network_mode: "service:service-perfectcage"
    restart: always

  # 5. Service Query
  service-query:
    build:
      context: .
      dockerfile: src/Service.Query/Dockerfile
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  service-query-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-query", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - service-query
    network_mode: "service:service-query"
    restart: always

  # 6. Service Notification
  service-notification:
    build:
      context: .
      dockerfile: src/Service.Notification/Dockerfile
    ports:
      - "5006:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  service-notification-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-notification", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - service-notification
    network_mode: "service:service-notification"
    restart: always

  # 7. Service OutboxWorker
  service-outbox-worker:
    build:
      context: .
      dockerfile: src/Service.OutboxWorker/Dockerfile
    environment:
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - dapr-network

  service-outbox-worker-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-outbox-worker", 
      "-placement-host-address", "placement:50005", 
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - service-outbox-worker
    network_mode: "service:service-outbox-worker"
    restart: always

  # 8. Business Coordinator
  business-coordinator:
    build:
      context: .
      dockerfile: src/BusinessCoordinator/Dockerfile
    ports:
      - "5007:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprSagaDB
      - nacos__ServerAddresses__0=http://nacos:8848
    depends_on:
      mongodb:
        condition: service_started
      placement:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      nacos:
        condition: service_started
    restart: always
    networks:
      - dapr-network

  business-coordinator-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "business-coordinator", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    environment:
      <<: *dapr-env
    depends_on:
      - business-coordinator
    network_mode: "service:business-coordinator"
    restart: always

  # 9. Nacos Server
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos-standalone
    environment:
      - MODE=standalone
      - JVM_XMS=256m
      - JVM_XMX=256m
    ports:
      - "8848:8848"
      - "9848:9848"
    networks:
      - dapr-network
    restart: always

networks:
  dapr-network:
    driver: bridge

volumes:
  mongo_data:
