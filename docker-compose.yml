version: '3.9'

services:
  ############################
  # Infrastructure Services
  ############################
  
  placement:
    image: daprio/dapr:1.16.5
    command: ["./placement", "--port", "50005"]
    ports:
      - "60006:50005"
    networks:
      - dapr-network

  scheduler:
    image: daprio/dapr:1.16.5
    command: ["./scheduler", "--port", "50006", "--etcd-data-dir", "/tmp/dapr-scheduler-data"]
    ports:
      - "50006:50006"
    networks:
      - dapr-network

  zipkin:
    image: openzipkin/zipkin
    ports:
      - "9411:9411"
    networks:
      - dapr-network

  mongodb:
    image: mongo:latest
    container_name: dapr_mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - dapr-network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: dapr_zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - dapr-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: dapr_kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - dapr-network

  ############################
  # Application Services
  ############################

  # 1. Saga Coordinator
  saga-coordinator:
    build:
      context: .
      dockerfile: src/Saga.Coordinator/Dockerfile
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprDemoDB
    depends_on:
      - mongodb
      - kafka
      - placement
      - scheduler
    networks:
      - dapr-network

  saga-coordinator-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "saga-coordinator", 
      "-app-port", "8080", 
      "-dapr-grpc-port", "50001",
      "-placement-host-address", "placement:50005",
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml",
      "-log-level", "debug"
    ]
    volumes:
      - ./docker-components/:/components
    depends_on:
      - saga-coordinator
    network_mode: "service:saga-coordinator"

  # 2. Service CTA
  service-cta:
    build:
      context: .
      dockerfile: src/Service.CTA/Dockerfile
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprDemoDB
    depends_on:
      - mongodb
      - kafka
      - placement
    networks:
      - dapr-network

  service-cta-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-cta", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    depends_on:
      - service-cta
    network_mode: "service:service-cta"

  # 3. Service Genesis
  service-genesis:
    build:
      context: .
      dockerfile: src/Service.Genesis/Dockerfile
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprDemoDB
    depends_on:
      - mongodb
      - kafka
      - placement
    networks:
      - dapr-network

  service-genesis-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-genesis", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    depends_on:
      - service-genesis
    network_mode: "service:service-genesis"

  # 4. Service PerfectCage
  service-perfectcage:
    build:
      context: .
      dockerfile: src/Service.PerfectCage/Dockerfile
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprDemoDB
    depends_on:
      - mongodb
      - kafka
      - placement
    networks:
      - dapr-network

  service-perfectcage-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-perfectcage", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    depends_on:
      - service-perfectcage
    network_mode: "service:service-perfectcage"

  # 5. Service Query
  service-query:
    build:
      context: .
      dockerfile: src/Service.Query/Dockerfile
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprDemoDB
    depends_on:
      - mongodb
      - kafka
      - placement
    networks:
      - dapr-network

  service-query-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-query", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    depends_on:
      - service-query
    network_mode: "service:service-query"

  # 6. Service Notification
  service-notification:
    build:
      context: .
      dockerfile: src/Service.Notification/Dockerfile
    ports:
      - "5006:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=DaprDemoDB
    depends_on:
      - mongodb
      - kafka
      - placement
    networks:
      - dapr-network

  service-notification-dapr:
    image: daprio/daprd:1.16.5
    command: ["./daprd", 
      "-app-id", "service-notification", 
      "-app-port", "8080", 
      "-placement-host-address", "placement:50005", 
      "-scheduler-host-address", "scheduler:50006",
      "-components-path", "/components",
      "-config", "/components/configuration.yaml"
    ]
    volumes:
      - ./docker-components/:/components
    depends_on:
      - service-notification
    network_mode: "service:service-notification"

networks:
  dapr-network:
    driver: bridge

volumes:
  mongo_data:
